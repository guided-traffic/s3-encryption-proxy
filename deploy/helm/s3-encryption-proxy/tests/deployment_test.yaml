suite: test deployment
templates:
  - deployment.yaml
  - service.yaml
  - configmap.yaml
  - serviceaccount.yaml
tests:
  - it: should render deployment
    asserts:
      - isKind:
          of: Deployment
      - equal:
          path: metadata.name
          value: RELEASE-NAME-s3-encryption-proxy
      - equal:
          path: spec.replicas
          value: 2

  - it: should render service
    template: service.yaml
    asserts:
      - isKind:
          of: Service
      - equal:
          path: metadata.name
          value: RELEASE-NAME-s3-encryption-proxy
      - equal:
          path: spec.ports[0].port
          value: 8080

  - it: should render configmap
    template: configmap.yaml
    asserts:
      - isKind:
          of: ConfigMap
      - equal:
          path: metadata.name
          value: RELEASE-NAME-s3-encryption-proxy-config

  - it: should render serviceaccount
    template: serviceaccount.yaml
    asserts:
      - isKind:
          of: ServiceAccount
      - equal:
          path: metadata.name
          value: RELEASE-NAME-s3-encryption-proxy

  - it: should set pod labels
    asserts:
      - equal:
          path: spec.template.metadata.labels["app.kubernetes.io/name"]
          value: s3-encryption-proxy
      - equal:
          path: spec.template.metadata.labels["app.kubernetes.io/component"]
          value: proxy

  - it: should configure security context
    asserts:
      - equal:
          path: spec.template.spec.securityContext.runAsUser
          value: 1001
      - equal:
          path: spec.template.spec.securityContext.runAsNonRoot
          value: true

  - it: should configure environment variables
    asserts:
      - contains:
          path: spec.template.spec.containers[0].env
          content:
            name: S3_ACCESS_KEY_ID
            valueFrom:
              secretKeyRef:
                name: RELEASE-NAME-s3-encryption-proxy-secrets
                key: access-key-id

  - it: should render certificate when enabled
    template: certificate.yaml
    set:
      certificate.enabled: true
    asserts:
      - isKind:
          of: Certificate
      - equal:
          path: metadata.name
          value: RELEASE-NAME-s3-encryption-proxy-tls

  - it: should not render certificate when disabled
    template: certificate.yaml
    set:
      certificate.enabled: false
    asserts:
      - hasDocuments:
          count: 0
